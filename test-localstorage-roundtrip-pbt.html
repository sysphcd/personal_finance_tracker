<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±¬æ€§æ¸¬è©¦ï¼šlocalStorage å¾€è¿”ä¸€è‡´æ€§</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #test-results {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pass {
            color: green;
        }
        .fail {
            color: red;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>å±¬æ€§æ¸¬è©¦ï¼šlocalStorage å¾€è¿”ä¸€è‡´æ€§</h1>
    
    <div class="info">
        <p><strong>Validates: Requirements 5.5</strong></p>
        <p><strong>å±¬æ€§ 5ï¼šlocalStorage å¾€è¿”ä¸€è‡´æ€§</strong></p>
        <p>å°æ–¼ä»»ä½•æ”¯å‡ºè¨˜éŒ„é™£åˆ—ï¼Œå„²å­˜åˆ° localStorage å¾Œå†è¼‰å…¥ï¼Œæ‡‰è©²å¾—åˆ°ç›¸åŒçš„è³‡æ–™ï¼ˆä¿ç•™é‡‘é¡å’Œé¡åˆ¥è³‡è¨Šï¼‰</p>
    </div>

    <button onclick="runTests()">åŸ·è¡Œå±¬æ€§æ¸¬è©¦</button>
    
    <div id="test-results"></div>

    <script src="script.js"></script>
    <script>
        // ç°¡åŒ–ç‰ˆçš„å±¬æ€§æ¸¬è©¦ï¼ˆç€è¦½å™¨ç’°å¢ƒï¼‰
        
        function generateRandomExpense() {
            const categories = ['é£²é£Ÿ', 'äº¤é€š', 'å¨›æ¨‚'];
            return {
                id: Math.random().toString(36).substring(2, 15),
                amount: Math.round((Math.random() * 10000 + 1) * 100) / 100,
                category: categories[Math.floor(Math.random() * categories.length)]
            };
        }

        function generateRandomExpensesArray(maxLength = 50) {
            const length = Math.floor(Math.random() * (maxLength + 1));
            const expenses = [];
            for (let i = 0; i < length; i++) {
                expenses.push(generateRandomExpense());
            }
            return expenses;
        }

        function testRoundTripConsistency(testExpenses) {
            // æ¸…ç©º localStorage
            localStorage.clear();
            
            // è¨­å®š expenses é™£åˆ—
            expenses = testExpenses;
            
            // å„²å­˜åˆ° localStorage
            saveToLocalStorage();
            
            // å¾ localStorage è¼‰å…¥
            const loadedExpenses = loadFromLocalStorage();
            
            // é©—è­‰é™£åˆ—é•·åº¦ç›¸åŒ
            if (loadedExpenses.length !== testExpenses.length) {
                return {
                    passed: false,
                    error: `é•·åº¦ä¸ä¸€è‡´ï¼šé æœŸ ${testExpenses.length}ï¼Œå¯¦éš› ${loadedExpenses.length}`
                };
            }
            
            // é©—è­‰æ¯ç­†è¨˜éŒ„çš„è³‡æ–™ä¸€è‡´æ€§
            for (let i = 0; i < testExpenses.length; i++) {
                const original = testExpenses[i];
                const loaded = loadedExpenses[i];
                
                // é©—è­‰ id
                if (loaded.id !== original.id) {
                    return {
                        passed: false,
                        error: `è¨˜éŒ„ ${i} çš„ id ä¸ä¸€è‡´ï¼šé æœŸ '${original.id}'ï¼Œå¯¦éš› '${loaded.id}'`
                    };
                }
                
                // é©—è­‰ amountï¼ˆè€ƒæ…®æµ®é»æ•¸ç²¾åº¦ï¼‰
                if (Math.abs(loaded.amount - original.amount) > 0.001) {
                    return {
                        passed: false,
                        error: `è¨˜éŒ„ ${i} çš„ amount ä¸ä¸€è‡´ï¼šé æœŸ ${original.amount}ï¼Œå¯¦éš› ${loaded.amount}`
                    };
                }
                
                // é©—è­‰ category
                if (loaded.category !== original.category) {
                    return {
                        passed: false,
                        error: `è¨˜éŒ„ ${i} çš„ category ä¸ä¸€è‡´ï¼šé æœŸ '${original.category}'ï¼Œå¯¦éš› '${loaded.category}'`
                    };
                }
            }
            
            return { passed: true };
        }

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h2>åŸ·è¡Œä¸­...</h2>';
            
            const numRuns = 100;
            let passed = 0;
            let failed = 0;
            let failedCases = [];
            
            for (let i = 0; i < numRuns; i++) {
                const testExpenses = generateRandomExpensesArray();
                const result = testRoundTripConsistency(testExpenses);
                
                if (result.passed) {
                    passed++;
                } else {
                    failed++;
                    failedCases.push({
                        run: i + 1,
                        expenses: testExpenses,
                        error: result.error
                    });
                }
            }
            
            // é¡¯ç¤ºçµæœ
            let html = '<h2>æ¸¬è©¦çµæœ</h2>';
            html += `<p>åŸ·è¡Œæ¬¡æ•¸ï¼š${numRuns}</p>`;
            html += `<p class="pass">âœ… é€šéï¼š${passed}</p>`;
            html += `<p class="fail">âŒ å¤±æ•—ï¼š${failed}</p>`;
            
            if (failed === 0) {
                html += '<h3 class="pass">ğŸ‰ æ‰€æœ‰æ¸¬è©¦éƒ½é€šéï¼</h3>';
            } else {
                html += '<h3 class="fail">ç™¼ç¾å•é¡Œï¼š</h3>';
                failedCases.forEach(failedCase => {
                    html += `<div style="background-color: #ffebee; padding: 10px; margin: 10px 0; border-radius: 5px;">`;
                    html += `<p><strong>æ¸¬è©¦ #${failedCase.run}</strong></p>`;
                    html += `<p>éŒ¯èª¤ï¼š${failedCase.error}</p>`;
                    html += `<p>æ¸¬è©¦è³‡æ–™ï¼š<pre>${JSON.stringify(failedCase.expenses, null, 2)}</pre></p>`;
                    html += `</div>`;
                });
            }
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
